let
    // PASSO 1: Referencia a tabela com os CNPJs
    // Substitua "Tabela1" pelo nome da sua tabela
    Fonte = Excel.CurrentWorkbook(){[Name="Tabela1"]}[Content],
    
    // PASSO 2: Garante que a coluna CNPJ seja texto
    TipoAlterado = Table.TransformColumnTypes(Fonte,{{"CNPJ", type text}}),
    
    // PASSO 3: Limpa o CNPJ (remove pontos, barras e traços)
    CNPJLimpo = Table.AddColumn(TipoAlterado, "CNPJ_Limpo", each 
        Text.Remove([CNPJ], {" ", ".", "/", "-"}), type text),
    
    // PASSO 4: Valida se o CNPJ tem 14 dígitos
    ValidaCNPJ = Table.AddColumn(CNPJLimpo, "CNPJ_Valido", each 
        if Text.Length([CNPJ_Limpo]) = 14 then "Sim" else "Não", type text),
    
    // PASSO 5: Cria a função de consulta
    ConsultarSimples = (cnpj as text) =>
        let
            // URL da consulta do Simples Nacional
            url = "https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATBHE/ConsultaOptante.app/ConsultarOpcao.aspx",
            
            // Tenta fazer a consulta
            Resultado = try 
                let
                    // Faz a requisição HTTP
                    Origem = Web.Page(
                        Web.Contents(
                            url,
                            [
                                Query=[cnpj=cnpj],
                                Headers=[
                                    #"User-Agent"="Mozilla/5.0",
                                    #"Content-Type"="application/x-www-form-urlencoded"
                                ]
                            ]
                        )
                    ),
                    
                    // Extrai o texto da página
                    Tabelas = Origem{0}[Data],
                    TextoDaPagina = Table.ToRows(Tabelas),
                    TextoCompleto = Text.Combine(List.Transform(TextoDaPagina, each Text.Combine(_, " "))),
                    
                    // Verifica se é optante
                    EhOptante = 
                        if Text.Contains(TextoCompleto, "Sim", Comparer.OrdinalIgnoreCase) or
                           Text.Contains(TextoCompleto, "optante pelo Simples Nacional", Comparer.OrdinalIgnoreCase)
                        then "OPTANTE"
                        else if Text.Contains(TextoCompleto, "Não", Comparer.OrdinalIgnoreCase) or
                                Text.Contains(TextoCompleto, "não optante", Comparer.OrdinalIgnoreCase)
                        then "NÃO OPTANTE"
                        else "Verificar manualmente"
                in
                    EhOptante
            otherwise "Erro na consulta"
        in
            Resultado,
    
    // PASSO 6: Aplica a consulta apenas para CNPJs válidos
    ConsultaSimples = Table.AddColumn(ValidaCNPJ, "Status_Simples_Nacional", each 
        if [CNPJ_Valido] = "Sim" 
        then ConsultarSimples([CNPJ_Limpo])
        else "CNPJ Inválido", type text),
    
    // PASSO 7: Remove colunas auxiliares
    RemoveColunas = Table.RemoveColumns(ConsultaSimples,{"CNPJ_Limpo", "CNPJ_Valido"})
in
    RemoveColunas
